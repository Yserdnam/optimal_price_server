<%- include('../header', { title: 'Pricing' }) %>

<main class="container pb-5">
  <div class="row justify-content-center">
    <div class="col-lg-10">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3 mb-0">
          <i class="fas fa-calculator me-2 text-primary"></i>Configuration Pricing
        </h1>
        <div>
          <a href="/" class="btn btn-outline-secondary me-2">
            <i class="fas fa-home me-1"></i>Accueil
          </a>
        </div>
      </div>

      <form action="/pricing/update" method="POST">
        <!-- Section Paramètres de Marge -->
        <div class="card shadow-sm mb-4">
          <div class="card-header bg-primary text-white">
            <h5 class="mb-0">
              <i class="fas fa-chart-line me-2"></i>Paramètres de Marge
            </h5>
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col-md-6 mb-3">
                <label for="MARGE_CIBLE" class="form-label fw-bold">
                  <i class="fas fa-bullseye me-1 text-info"></i>Marge Cible
                  <span class="text-danger">*</span>
                </label>
                <div class="input-group">
                  <input type="number" class="form-control" id="MARGE_CIBLE" name="MARGE_CIBLE" 
                         value="<%= (pricing.MARGE_CIBLE * 100).toFixed(2) %>" step="0.01" min="0" max="100" required>
                  <span class="input-group-text">%</span>
                </div>
                <div class="form-text">Marge bénéficiaire cible souhaitée pour vos produits</div>
              </div>
              <div class="col-md-6 mb-3">
                <label for="MIN_MARGIN" class="form-label fw-bold">
                  <i class="fas fa-shield-alt me-1 text-warning"></i>Marge Minimum
                  <span class="text-danger">*</span>
                </label>
                <div class="input-group">
                  <input type="number" class="form-control" id="MIN_MARGIN" name="MIN_MARGIN" 
                         value="<%= (pricing.MIN_MARGIN * 100).toFixed(2) %>" step="0.01" min="0" max="100" required>
                  <span class="input-group-text">%</span>
                </div>
                <div class="form-text">Marge minimale acceptable pour rester rentable</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Section Pondérations des Facteurs -->
        <div class="card shadow-sm mb-4">
          <div class="card-header bg-primary text-white">
            <h5 class="mb-0">
              <i class="fas fa-balance-scale me-2"></i>Pondérations des Facteurs
            </h5>
            <small class="opacity-75">La somme des pondérations doit être égale à 100%</small>
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col-md-6 col-lg-3 mb-3">
                <label for="POIDS_CONCURRENTS" class="form-label fw-bold">
                  <i class="fas fa-store me-1 text-success"></i>Concurrence
                  <span class="text-danger">*</span>
                </label>
                <div class="input-group">
                  <input type="number" class="form-control" id="POIDS_CONCURRENTS" name="POIDS_CONCURRENTS" 
                         value="<%= (pricing.POIDS_CONCURRENTS * 100).toFixed(2) %>" step="0.01" min="0" max="100" required>
                  <span class="input-group-text">%</span>
                </div>
                <div class="form-text">
                  <small>
                    <strong>Importance des prix concurrents</strong><br>
                    Valeur élevée = Suivre les prix du marché<br>
                    Valeur faible = Prioriser d'autres facteurs
                  </small>
                </div>
              </div>
              <div class="col-md-6 col-lg-3 mb-3">
                <label for="POIDS_MARGE" class="form-label fw-bold">
                  <i class="fas fa-money-bill-wave me-1 text-info"></i>Marge
                  <span class="text-danger">*</span>
                </label>
                <div class="input-group">
                  <input type="number" class="form-control" id="POIDS_MARGE" name="POIDS_MARGE" 
                         value="<%= (pricing.POIDS_MARGE * 100).toFixed(2) %>" step="0.01" min="0" max="100" required>
                  <span class="input-group-text">%</span>
                </div>
                <div class="form-text">
                  <small>
                    <strong>Importance de votre marge bénéficiaire</strong><br>
                    Valeur élevée = Prioriser la rentabilité<br>
                    Valeur faible = Accepter des marges plus basses
                  </small>
                </div>
              </div>
              <div class="col-md-6 col-lg-3 mb-3">
                <label for="POIDS_QUARTIER" class="form-label fw-bold">
                  <i class="fas fa-map-marker-alt me-1 text-danger"></i>Quartier
                  <span class="text-danger">*</span>
                </label>
                <div class="input-group">
                  <input type="number" class="form-control" id="POIDS_QUARTIER" name="POIDS_QUARTIER" 
                         value="<%= (pricing.POIDS_QUARTIER * 100).toFixed(2) %>" step="0.01" min="0" max="100" required>
                  <span class="input-group-text">%</span>
                </div>
                <div class="form-text">
                  <small>
                    <strong>Importance de la localisation</strong><br>
                    Valeur élevée = Adapter les prix au quartier<br>
                    Valeur faible = Prix uniformes partout
                  </small>
                </div>
              </div>
              <div class="col-md-6 col-lg-3 mb-3">
                <label for="POIDS_INFLUENCE" class="form-label fw-bold">
                  <i class="fas fa-star me-1 text-warning"></i>Influence
                  <span class="text-danger">*</span>
                </label>
                <div class="input-group">
                  <input type="number" class="form-control" id="POIDS_INFLUENCE" name="POIDS_INFLUENCE" 
                         value="<%= (pricing.POIDS_INFLUENCE * 100).toFixed(2) %>" step="0.01" min="0" max="100" required>
                  <span class="input-group-text">%</span>
                </div>
                <div class="form-text">
                  <small>
                    <strong>Importance de la notoriété</strong><br>
                    Valeur élevée = Prix premium pour image de marque<br>
                    Valeur faible = Priorité au prix compétitif
                  </small>
                </div>
              </div>
            </div>
            
            <!-- Guide des pondérations -->
            <div class="alert alert-info mt-3">
              <div class="d-flex">
                <div class="me-3">
                  <i class="fas fa-lightbulb fa-2x"></i>
                </div>
                <div>
                  <h6 class="alert-heading">Comment choisir vos pondérations ?</h6>
                  <p class="mb-1">Exemples de configurations typiques :</p>
                  <ul class="mb-0">
                    <li><strong>Stratégie agressive</strong> : Concurrence (50%), Marge (30%), Quartier (15%), Influence (5%)</li>
                    <li><strong>Stratégie premium</strong> : Influence (40%), Marge (35%), Quartier (20%), Concurrence (5%)</li>
                    <li><strong>Stratégie équilibrée</strong> : Tous les facteurs autour de 25%</li>
                  </ul>
                </div>
              </div>
            </div>
            
            <!-- Total et validation -->
            <div class="row mt-3">
              <div class="col-md-8">
                <div class="alert" id="validationAlert">
                  <div class="d-flex align-items-center">
                    <div id="validationIcon" class="me-3 fs-4"></div>
                    <div id="validationMessage"></div>
                  </div>
                </div>
              </div>
              <div class="col-md-4">
                <label class="form-label fw-bold">Total des pondérations</label>
                <div class="card">
                  <div class="card-body text-center py-3">
                    <span class="h4 mb-0" id="totalPonderation">0.00%</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Boutons d'action -->
        <div class="d-flex flex-wrap gap-2 mb-4">
          <button type="submit" class="btn btn-success" id="submitBtn">
            <i class="fas fa-save me-1"></i>Enregistrer la configuration
          </button>
          <button type="button" class="btn btn-warning" onclick="resetForm()">
            <i class="fas fa-undo me-1"></i>Annuler les modifications
          </button>
          <a href="/" class="btn btn-secondary">
            <i class="fas fa-arrow-left me-1"></i>Retour à l'accueil
          </a>
        </div>
      </form>

      <!-- Réinitialisation aux valeurs d'usine -->
      <div class="card border-warning">
        <div class="card-header bg-warning text-dark">
          <h6 class="mb-0">
            <i class="fas fa-exclamation-triangle me-2"></i>Options avancées
          </h6>
        </div>
        <div class="card-body">
          <p class="mb-3">Réinitialiser tous les paramètres aux valeurs par défaut :</p>
          <form action="/pricing/reset" method="POST">
            <button type="submit" class="btn btn-outline-danger" onclick="return confirm('Êtes-vous sûr de vouloir réinitialiser tous les paramètres aux valeurs d\'usine ? Cette action est irréversible.')">
              <i class="fas fa-trash-alt me-1"></i>Réinitialiser aux valeurs par défaut
            </button>
          </form>
        </div>
      </div>
    </div>
  </div>
</main>

<script>
  // Calcul automatique du total des pondérations
  function calculateTotal() {
    const inputs = [
      'POIDS_CONCURRENTS',
      'POIDS_MARGE', 
      'POIDS_QUARTIER',
      'POIDS_INFLUENCE'
    ];
    
    let total = 0;
    inputs.forEach(id => {
      const value = parseFloat(document.getElementById(id).value) || 0;
      total += value;
    });
    
    document.getElementById('totalPonderation').textContent = `${total.toFixed(2)}%`;
    
    const submitBtn = document.getElementById('submitBtn');
    const validationAlert = document.getElementById('validationAlert');
    const validationIcon = document.getElementById('validationIcon');
    const validationMsg = document.getElementById('validationMessage');
    
    if (Math.abs(total - 100) < 0.01) {
      validationAlert.className = 'alert alert-success';
      validationIcon.innerHTML = '✅';
      validationMsg.innerHTML = '<strong>Configuration valide</strong><br>La somme des pondérations est correcte.';
      submitBtn.disabled = false;
    } else {
      validationAlert.className = 'alert alert-danger';
      validationIcon.innerHTML = '❌';
      validationMsg.innerHTML = `<strong>Configuration invalide</strong><br>La somme des pondérations doit être égale à 100% (actuellement: ${total.toFixed(2)}%).`;
      submitBtn.disabled = true;
    }
  }
  
  // Ajouter les événements sur les inputs
  document.addEventListener('DOMContentLoaded', function() {
    const inputs = [
      'POIDS_CONCURRENTS',
      'POIDS_MARGE', 
      'POIDS_QUARTIER',
      'POIDS_INFLUENCE'
    ];

    inputs.forEach(id => {
      document.getElementById(id).addEventListener('input', calculateTotal);
    });
    
    calculateTotal(); // Calcul initial
  });
  
  function resetForm() {
    if (confirm('Annuler toutes les modifications non enregistrées ?')) {
      window.location.reload();
    }
  }
</script>

<%- include('../footer') %>